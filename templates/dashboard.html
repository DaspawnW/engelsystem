<div class="row forecast">
    <div class="upcoming-shifts">
        %number_upcoming_shifts%
    </div>
    <div class="upcoming-night-shifts">
        %number_upcoming_night_shifts%
    </div>
    <div class="currently-working">
        %number_currently_working%
    </div>
    <div class="hours-worked">
        %number_hours_worked%
    </div>
</div>

<div class="row google">
    <div class="google-container" id="google-container">

    </div>
</div>

<div class="row blocks">
    <section class="job-list">
        %jobs_currently_running%
    </section>

    <section class="job-list">
        %jobs_now%
        %jobs_soon%
    </section>
    <section class="news">
        <div class="clock well" id="clockDisplay">??:??:??</div>
        %news%
    </section>
</div>

<script>
    var LatLngList = [], marker = [], infowindow = [], map, contentHtml;
    initEmptyCard();

    showUpcomingShifts();

    renderTime();

    function initEmptyCard() {
        var latitude = 51;
        var longitude = 10;
        var home = new google.maps.LatLng(latitude,longitude);
        var options = {
            center: home,
            zoom: 5,
            mapTypeId: google.maps.MapTypeId.HYBRID
        };
        map = new google.maps.Map(document.getElementById("google-container"),options);
    }

    function showUpcomingShifts() {
        var url = "%api_shifts_link%";
        jQuery.support.cors = true;
        $.ajax({
            url: url,
            dataType: "json",
            error:function(xhr, status, errorThrown) {
                console.log(errorThrown+'\n'+status+'\n'+xhr.statusText);
            },
            success: function(o){
                displayShifts(o);
            }
        });
    }

    function displayShifts(shifts) {
        contentHtml = [];
        for(i in shifts) {
            var shift = shifts[i];
            if ('' === shift.lat || '' === shift.long) {
                continue;
            }

            var coords = new google.maps.LatLng(shift.lat, shift.long);
            LatLngList[i] = coords;
            if (typeof marker[shift.RID] === 'undefined') {
                marker[shift.RID] = new google.maps.Marker({
                    position: coords,
                    title: shift.locationName,
                    map: map,
                    dragable: false
                });
                var html = "<section class=\"location-infowindow\">" +
                        "    <h4>"+ shift.locationName + "</h4>" +
                        "    <div class=\"location-content-infowindow\"></div>" +
                        "</section>";
                html = html + buildHTMLContent(shift);

                contentHtml[shift.RID] = html;

                google.maps.event.addListener(marker[shift.RID], 'click',
                        openShiftDetails(shift.RID, marker[shift.RID])
                );
            } else {
                contentHtml[shift.RID] = contentHtml[shift.RID] + "<br />" + buildHTMLContent(shift);
            }
        }

        if (LatLngList.length != 0){
            var bounds = new google.maps.LatLngBounds ();
            for (var i = 0, LtLgLen = LatLngList.length; i < LtLgLen; i++) {
                bounds.extend (LatLngList[i]);
            }
            map.fitBounds (bounds);
        }
    }

    function openShiftDetails(RID, marker) {
        var infowindow = new google.maps.InfoWindow({
            content : contentHtml[RID],
            maxWidth: 300
        });
        return function() {
            infowindow.open(map, marker);
        };
    }

    function buildHTMLContent(shift) {
        var startDate = new Date(shift.start * 1000);
        var endDate = new Date(shift.end * 1000);
        var startDateString = startDate.getHours() + ':' + ("0" + startDate.getMinutes()).substr(-2);
        var endDateString = endDate.getHours() + ':' + ("0" + endDate.getMinutes()).substr(-2);
        var html = "<section class=\"shift-infowindow\">" +
                "   <h5>" + shift.title + "</h5>" +
                "   <div class=\"shift-content-infowindow\">" +
                "       <h6>" + startDateString + " - " + endDateString + "</h6>"
                "   </div>" +
                "</section>";

        return html;
    }

    function renderTime() {
        var currentTime = new Date();
        var diem = "AM";
        var h = currentTime.getHours();
        var m = currentTime.getMinutes();
        var s = currentTime.getSeconds();
        setTimeout('renderTime()',1000);
        if (h == 0) {
            h = 12;
        } else if (h > 12) {
            h = h - 12;
            diem="PM";
        }
        if (h < 10) {
            h = "0" + h;
        }
        if (m < 10) {
            m = "0" + m;
        }
        if (s < 10) {
            s = "0" + s;
        }
        var myClock = document.getElementById('clockDisplay');
        myClock.textContent = h + ":" + m + ":" + s + " " + diem;
        myClock.innerText = h + ":" + m + ":" + s + " " + diem;
    }

</script>
